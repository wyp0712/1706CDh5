<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      list-style: none;
    }

    html,
    body {
      width: 100%;
      height: 100%;
    }

    .wrap {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .header {
      width: 100%;
      height: 45px;
      background: red;
    }

    .nav {
      width: 100%;
      height: 40px;
      background: navajowhite;
      display: flex;
    }

    .nav span {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .active {
      color: red;
    }

    .main {
      flex: 1;
      overflow: hidden;
      width: 100%;
    }

    .swiper-box {
      width: 100%;
    }

    .swiper-container {
      width: 100%;
      height: 150px;
    }

    .swiper-container .swiper-wrapper {
      width: 100%;
      height: 150px;
    }

    .swiper-container .swiper-wrapper .swiper-slide {
      width: 100%;
      height: 150px;
    }

    .swiper-container .swiper-wrapper .swiper-slide img {
      width: 100%;
      height: 150px;
    }

    .item {
      width: 100%;
      padding: 5%;
      height: 120px;
      position: relative;
      border-bottom: 1px dashed black;
    }

    .item .myCanvas {
      position: absolute;
      right: 8%;
      top: 2%;
    }

    .content {
      width: 100%;
      position: relative;
    }

    .content::before {
      content: attr(data-top);
      display: block;
      width: 100%;
      height: 40px;
      background: lightblue;
      text-align: center;
      line-height: 40px;
      position: absolute;
      top: -40px;
    }
  </style>

  <link rel="stylesheet" href="../libs/swiper.css">
</head>

<body>


  <div class="wrap">
    <header class="header">
      <a href="./city.html" class="cityA">北京</a>
    </header>

    <div class="swiper-box">
    </div>

    <nav class="nav">
      <span class="active">正在热映</span>
      <span>即将上映</span>
    </nav>

    <div class="main">
      <div class="content" data-top="下拉刷新" data-bottom="上拉加载"></div>
    </div>
  </div>



  <script src="../libs/swiper.js"></script>
  <script src="../libs/ajax.js"></script>
  <script src="../libs/bscroll.js"></script>
  <script>

    var myMovie = function () {
      this.navSpans = document.querySelectorAll('.nav span')
      this.main = document.querySelector('.main')
      this.content = document.querySelector('.content')
      this.swiperBox = document.querySelector('.swiper-box')
      this.cityA = document.querySelector('.cityA')
      this.stroge = window.localStorage;

      this.init()
    }
    myMovie.prototype = {
      init: function () {
        this.getAjax(0)
        this.bindEvent()
        this.stroageFn()

        this.myBscroll()
      },
      stroageFn: function () {
        if (this.stroge.city) {
          this.cityA.innerHTML = this.stroge.city;
        }
      },
      getAjax: function (index) {
        ajax('./data.json', (res) => {
          // console.log(res, 'res')
          this.render(res.swiper, 'swiper')
          this.render(res.movieArr, 'movie', index)
        })
      },
      bindEvent: function () {
        this.navSpans.forEach((item, index) => {
          item.onclick = () => {
            for (var i = 0; i < this.navSpans.length; i++) {
              this.navSpans[i].classList.remove('active');
            }
            item.classList.add('active');
            this.getAjax(index)
          }
        })
      },
      render: function (data, dir, index) {
        if (dir == 'swiper') {

          this.swiperBox.innerHTML = `<div class="swiper-container">
            <div class="swiper-wrapper">
               ${ data.map(item => {
            return `<div class='swiper-slide'> <img src=${item.img}> </div>`
          }).join('')}
            </div>
          </div>`;

        } else if (dir === 'movie') {

          this.content.innerHTML = data.map(item => {
            if (item.globalReleased && index === 0) {
              return `<div class=item> ${item.nm} <canvas class=myCanvas width= "100" height= "100" data-sc = ${item.sc}></canvas>  </div>`
            } else if (!item.globalReleased && index == 1) {
              return `<div class=item> ${item.nm} <canvas class=myCanvas width= "100" height= "100" data-sc = ${item.sc}></canvas>  </div>`
            }
          }).join('')
        }
        this.mySwiper()
        this.myGrade()

      },
      // canvas评分区域
      myGrade: function () {
        this.myCanvas = document.querySelectorAll('.myCanvas');
        this.myCanvas.forEach(item => {
          this.api = item.getContext('2d');
          var sc = item.dataset.sc;
          var deg = sc / 10 * 360 * Math.PI / 180;
          // console.log(sc / 10 * 360)
          createText(this.api, sc, item.width / 2, item.height / 2);
          this.api.beginPath();
          this.api.arc(item.width / 2, item.height / 2, 28, 0, deg)
          this.api.lineWidth = 10;
          // this.api.lineCap = 'round';
          this.api.strokeStyle = 'red';
          this.api.stroke()
        })
        function createText(api, text, x, y) {
          api.font = '12px sans-serif';
          api.textAlign = 'center';
          api.textBaseline = 'middle';
          if (text == 0) {
            api.fillText('暂无评分', x, y)
          } else {
            api.fillText(text, x, y)
          }
        }
      },
      mySwiper: function () {
        new Swiper('.swiper-container')
      },
      myBscroll: function () {
        this.bs = new BScroll('.main', {

        })
      },

    }
    new myMovie()


  </script>




</body>

</html>